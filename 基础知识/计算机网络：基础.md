# 计算机网络：基础

> 对《图解TCP/IP》做一个简单的阅读笔记。

### 索引

* 层次划分
* 数据链路层/网络接口层
* 网络层
* 传输层
* 应用层

## 层次划分

### OSI七层模型

IOS制定的OSI七层模型如下：

![OSI模型](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750912.PNG)

各层功能如下：

* **应用层：**为操作系统或网络应用程序提供访问网络服务的接口；

* **表示层：**将应用处理的信息转换为适合网络传输的格式，或将来自下一层的数据转换为上层能处理的格式；主要负责数据格式的转换；

* **会话层：**进行通讯管理，负责建立和断开通讯连接；

* **传输层：**实现网络不同主机上用户进程之间的数据通信，可靠与不可靠的传输，传输层的错误检测，流量控制等；

* **网络层：**提供逻辑地址(IP)，为不同局域网的主机通讯提供路由寻址，将数据传输到目标地址；

* **数据链路层：**管理相邻节点之间的数据通信；

* **物理层：**将数据转化为比特流，设备之间的比特流传输。

### TCP/IP模型

TCP/IP模型以及和IOS制定的OSI模型的对照关系如下：

![tcp_ip](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750727.PNG)

* **应用层**决定了向用户提供应用服务时通信活动；
* **传输层**提供处于网络连接中的两台计算机之间的数据传输；
* **网络层**用来处理在网络上流动的数据包；
* **链路层**用来处理连接网络的硬件部分。

### TCP/IP通信示例

![通信示例](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750151.PNG)

### 搭建网络的主要设备

**网卡：**

网络接口卡（Network Information Center），一般而言，一块网卡对应着一个MAC地址；

**中继器**

对应于OSI模型中的第一层，在物理层上延长了网络的设备；

**网桥/2层交换机**

![网桥](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750327.PNG)

对应于OSI模型中的第二层，将两个LAN连接起来，根据MAC地址来转发帧数据；

**路由器/3层交换机**

![路由器](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750738.PNG)

在网络层面上，连接两个网络，根据IP地址来进行数据的路由选择，数据转发；

**4~7层交换机**

![4_7层交换机](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750339.PNG)

负责处理OSI模型从传输层至应用层的数据；对于TCP/IP模型，则是传输层与应用层的数据；

4~7层交换机是以TCP等协议的传输层以及上面的应用层为基础，分析收发数据；

例如可以进行带宽控制，负载均衡，特殊应用访问...

**网关**

![网关](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750661.PNG)

OSI参考模型中负责将从传输层到应用层的数据进行转换和转发的设备，可以对两个不能直接进行通讯的协议进行翻译，最终实现通讯。

关于网关的解释：http://www.lotpc.com/lyqzs/7981.html

## 数据链路层/网络接口层

### MAC地址

#### 概述

Media Access Control Address，物理地址/硬件地址，长48比特，一般一块网卡都具有唯一的MAC地址；

用于识别数据链路层中互联的节点，通过MAC地址来判断目标地址。

![MAC](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750067.PNG)

#### MAC地址表

记录了MAC地址与网络接口之间的对应关系。

### 以太网

#### 以太网协议

以太网是一种使用广泛的**局域网**技术；应用于数据链路层；使用以太网可以完成相邻设备的数据帧传输；

#### MTU

MTU(Max Transmission Unit)，是指数据链路层向网络层发数据的最大传输单元；

**路径MTU**，为链路中MTU的最小值。

以太网中的MTU一般为1500，当传输的数据大于MTU时，需要对数据进行分片处理。

#### 以太网数据帧格式

![以太网数据帧格式](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750640.PNG)

**类型：**

* 0800：IPv4
* 0806：ARP
* ...

**FCS**(Frame Check Sequence, 帧检验序列)：用于校验，其中写入的是**循环冗余校验码(CRC)**，作为数据的校验。

## 网络层

### IP地址

#### 概述

在TCP/IP通信时，用IP地址来识别主机和路由器。

IP地址由”网络标识（网络地址）“和”主机标识（主机地址）“两部分组成。

![IP标识](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750165.PNG)

#### IP地址分类

![地址分类](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750075.PNG)



> 特殊网络号：
>
> * A类地址网络段全为0（00000000）表示特殊网络；
>* A类地址网络段全为1（01111111 -> 127）表示回环地址；
> * B类地址网络段（10000000.00000000 -> 128.0）不可使用；
>* C类地址网络段（11000000.00000000.00000000 -> 192.0.0）不可使用
> 
>特殊主机号：
> 
> - 主机号全为0，表示当前网络段，不可分配为特定主机；
> - 主机号全为1，表示广播地址，向当前网络段内的所有主机发送消息；

|      | 最小网络号 | 最大网络号  | 子网数量 |
| ---- | ---------- | ----------- | -------- |
| A类  | 1          | 127         | 2^7 - 2  |
| B类  | 128.1      | 191.255     | 2^14 - 1 |
| C类  | 192.0.1    | 233.255.255 | 2^21 - 1 |

|      | 最小主机号 | 最大主机号  | 主机数量 |
| ---- | ---------- | ----------- | -------- |
| A类  | 0.0.1      | 255.255.254 | 2^24 - 2 |
| B类  | 0.1        | 255.254     | 2^16 - 2 |
| C类  | 1          | 254         | 2^8 - 2  |

#### 划分子网

为了减少IP地址的浪费，而采取的一种新组合方式，来表示IP地址；

通过**子网掩码**，将ABC类网络进更小粒度的划分；

两种表示方式：

* IP地址+子网掩码(连续的0和1)：前26位为网络地址 --> 255.255.255.192
* IP地址+'/'：前26位为网络地址：IP地址/26

![子网掩码](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750062.PNG)

根据IP地址和子网掩码获取网络地址的方式：将IP地址与子网掩码进行**按位与**操作即可。

#### CIDR

CIDR（Classless Inter-Domain Routing，无类型域间选路），放弃了IP地址的分类，采用了任意长度分割IP地址的网络标识和主机标识；

CIDR将网络前缀相同的IP地址称为一个“CIDR地址块”，而网络前缀是任意位数的；

采用斜线记法，例如： IP地址号/25

| CIDR前缀长度 | 掩码点分十进制 | 地址数 |
| ------------ | -------------- | ------ |
| /13          | 255.248.0.0    | 512k   |
| /14          | 255.252.0.0    | 256k   |
| ...          | ...            | ...    |
| /19          | 255.255.244.0  | 8k     |

### IP数据表格式

![IPv4首部](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750749.PNG)

**版本：**4bit构成

* 4：IP
* 6：IPv6

**首部长度：**4bit构成

* 表明IP首部大小，单位为4byte（32bit）；
* 对于没有可选字段的IP包，设置为5，即5*4=20byte

**总长度：**16bit构成

* 表示IP首部和数据部分合起来的总长度；
* 最大值为65535（2^16）

**标识：**16bit构成

* 用于分片重组，同一分片标识值相同，不同分片标识值不同；
* 通常会随着发送的IP包而增加；

**片偏移：**13bit构成

* 标识被分片的数据在原始数据中的位置；
* 第一个分片数据对应值为0，其单位为8字节，因此可表示最大数据长度为：8*2^13=2^16=65535

**生存时间：**在网络中没经过一个路由，值减一，为0时，丢弃数据包；

**协议：**8bit构成

* 1：ICMP：Internet Control Message
* 4：IP：IP in IP
* 6：TCP：Transmission Control Protocol
* 17：UDP：User Datagram

**首部校验和：**16bit构成，只校验数据报首部，不校验数据部分

**源地址/目的地址：**即源和目标的IP地址

### 路由控制

#### 概述

通过IP地址，将数据发送到最终的目的地址。

![路由控制](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750782.PNG)

#### 路由控制表

路由控制表中记录着网络地址与下一跳应该发送至路由器的地址；

发送IP数据包时，根据IP数据包首部的目标地址，查询路由表控制表，将IP数据包进行转发。

### 网络层协议

#### ARP/RARP

ARP（Address Resolution Protocol）,地址解析协议，根据IP地址来获取物理地址的协议；

ARP借助于ARP请求与APR相应两种类型的包来确定MAC地址；

![ARP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750789.PNG)

> 主机A通过广播发送一个ARP请求包；
>
> 当主机B发现ARP请求包中的IP地址与自己的IP地址相同时，返回ARP相应包

**ARP包格式**

![ARP数据格式](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750254.PNG)

RARP（Reverse Address Resolution Protocol），逆地址解析协议，根据MAC地址来获取IP地址；

![RARP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750655.PNG)

#### ICMP

ICMP（Internet Control Message Protocol），网络控制报文协议，用于辅助IP协议，数据封装在IP数据中

主要功能：确认IP包是否成功到达目标地址；通知在发送过程中IP包被丢弃的原因；改善网络设置等；

ICMP的消息大致可分为两类：

* 通知出错原因的**错误消息**；

* 用于诊断的**查询消息**；

![ICMP无法到达消息](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750154.PNG)

> 其中ping与tracetoute都是在充分利用ICMP协议的基础上实现的

#### DHCP

DHCP(Dynamic Host Configuration Protocol)，动态主机配置协议；

DHCP实现了即插即用，当计算机连接到局域网中时，根据DHCP，会自动为计算机分配IP地址，自动获取TCP/IP通信所必须的设置信息；

DHCP工作机制：

![DHCP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750571.PNG)

#### NAT

NAT（Network Address Translator），网络地址转换技术，是在本地网络中使用私有地址，在连接互联网时转而使用全局IP地址的技术。

**内网地址：**

* 10.0.0.0~10.255.255.255（支持千万数量级设备）
* 172.16.0.0~172.31.255.255（支持百万数量级设备）
* 192.168.0.0~192.168.255.255（支持万数量级设备）

**NAT工作机制：**

![NAT](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750095.PNG)

**NAPT：**

NAT+P=NAPT，Network Address Port Translator

![NAPT](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251750499.PNG)

### 路由协议

#### 概述

路由控制协议大致分为两类：一类是**外部网关协议EGP（Exterior Gateway Protocol）**，一类是内部网关协议**IGP（Interior Gateway Protocol）**；

网路拓扑结构如下：

![EGPIGP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751596.PNG)

#### 路由算法

距离向量算法，Distance Vector

* 根据距离和方向确定目标网络或目标主机位置的一种方法；
* 路由器之间通过互换目标网络的方向及其距离的相关信息，并以这些信息为基础制作路由控制表
* ![DV](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751777.PNG)

链路状态算法，Link-State

* 在了解网络整体连接状态的基础上生成路由控制表的一种方法；
* 所有路由都持有相同的信息，对于任意一台路由器网络的拓扑信息都一样；
* ![LS](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751074.PNG)

#### RIP协议

RIP（Routing Information Protocol）是距离向量向量型的一种内部网关路由协议；

RIP协议把网络的跳数（hop）作为DV算法的距离，根据距离向量生成距离向量表，再抽出较小的路由生成最终的路由控制表

RIP协议每隔30s交换一次路由信息；

RIP协议把hop>15的路由当做不可达路由，这这就限制了网路的规模；

![RIP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751414.PNG)

![RIP生成路由控制表](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751714.PNG)

#### OSPF协议

OSPF（Open Shortest Path First）开放最短路径优先协议，是一种内部网关链路状态型路由协议；

路由器之间交换链路的状态生成网络拓扑信息，然后根据这个拓扑信息来生成路由控制表；

只有链路状态发生变化时，才会发送更新信息；

在进行路由选择时，对每条路径赋予一个权重，并始终选择一个权重最小的路径作为最终路由。

![OSPF](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751313.PNG)

#### RIP/OSPF比较

| RIP协议                  | OSPF协议                         |
| ------------------------ | -------------------------------- |
| 从邻居看网络             | 看整个网路偶的拓扑               |
| 在路由器之间累加距离     | Dijkstra算法计算最短路径         |
| 更新周期频繁，收敛速度慢 | 状态变化才更新，收敛很快         |
| 路由间拷贝路由信息       | 路由间传递链路状态，自行计算路径 |

#### BGP协议

BGP（Border Gateway Protocol），边界网关协议，一种外部网关协议；

运行在自治系统（AS）之间的一种协议；

只有BGP，RIP，OSPF协议共同进行路由控制，才能进行整个互联网的路由控制；

![BGP](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751938.PNG)

![BGP2](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751183.PNG)

## 传输层

### 端口号

端口号用来识别同一台计算机中进行通信的不同应用程序，即不同的网络进程，也被称为程序地址；

TCP/IP，UDP/IP通信中一般通过5个信息来进行识别：

* 源IP地址；
* 目标IP地址；
* 协议号；
* 源端口号；
* 目标端口号

![识别多个请求](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751141.PNG)

常用的端口号：

| FTP  | HTTP | HTTPS | DNS  | TELNET | ...  |
| ---- | ---- | ----- | ---- | ------ | ---- |
| 21   | 80   | 443   | 53   | 23     | ...  |

### UDP

#### 概述

UDP，User Datagram Protocol，一种简单的协议；

面向**无连接**，可以随时发送数据，无法保证数据在网络中是否丢失；

常应用于：

* 包总量较少的通信（DNS，SNMP）；
* 视频，音频等多媒体通信（即时通信）；
* 限定于LAN等特定网络中的应用通信；
* 广播通信（广播，多播）

#### UDP协议头部：

![UDP数据报首部](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751245.PNG)

### TCP

#### 概述

TCP，Transmission Control Protocol，传输控制协议；

* 面向连接的协议，TCP负责控制连接的建立，断开，保持等管理工作；
* TCP的一个连接有两端（点对点通信）；
* TCP提供可靠服务的协议；
* TCP协议提供全双工的通信；
* TCP是面向**字节流**的协议，而UDP是面向**数据报**的协议；

#### TCP协议头部：

![TCP协议头部](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751991.PNG)

**序号seq：**

* 发送数据的位置值；
* 每发送一次数据，就累加一次该数据字节数大小，即一个字节就是一个序列号；
* 在建立连接时随机生成一个值；

**应答确认号ack：**

* 一个字节一个序号；
* 指下一次应该收到的数据的首字节序列号；

**数据偏移：**

* 字段长4位，单位为4byte，总共可以表示15*4=60字节的长度；
* 可以看做TCP首部的长度，即TCP的数据部分从TCP包的哪个部分开始计算；
* 由于TCP头部的固定长度为20字节，当没有扩展数据时，设置为5；

**控制位：**

![控制位](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751406.PNG)

* UGR（Urgent Flag）：紧急位，=1时，表示包中有紧急处理的数据；
* ACK（Acknowledgement Flag）：确定位，=1时，确认应答的字段有效；
* PSH（Push Flag）：推送位，=1时，尽快把数据交付给应用层，=0时，不需要立即传送，可以对数据进行缓存；
* RST（Reset Flag）：重置位，=1时，出现异常，强制断开连接；
* SYN（Synchronize Flag）：同步位，=1时，表示希望建立连接；
* FIN（Fin Flag）：终止位，=1时，表示今后不会再有数据，希望断开连接；

**窗口大小：**指明了允许对方发送的数据量大小；

**校验和：**用于校验数据；

**紧急指针：**

* 当UGR置1时有效；
* 指出了从数据首位到紧急指针所指示的位置为紧急数据，即指出了紧急数据的末尾在报文中的位置；

**TCP选项：**

* 提高TCP传输性能；
* 最大长度为40字节；

#### TCP的可靠传输

**停止等待协议：**

* 无差错情况：当发送方发送一个消息后，需要停止等待直到接受到接收方的确认应答消息后，才会继续传输数据；

![停止等待](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751188.PNG)

* 有差错：
  * 发送消息在路上丢失了；
  * 确认消息在路上丢失了；
  * 确认消息过了很久才到；

* TCP传输第一个定时器：**超时定时器**，每发送一个消息前，都需要设定一个定时器

![超时定时器](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751996.PNG)

**ARQ协议：**

* Automatic Repeate reQuest：自动重传请求；
* 引入窗口概念，窗口大小，无需等待确认应答而可以继续发送数据；

![滑动窗口](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751058.PNG)

* **连续ARQ协议**：滑动窗口+累加确认

![连续ARQ](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751860.PNG)

#### 流量控制

**流量控制：**TCP可以让发送端根据接收端的实际接收能力控制发送的数据量；

TCP首部中，有一个字段用来通知窗口大小，根据窗口大小可以进行流量控制；

![流量控制](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751591.PNG)

TCP中的第二个定时器：**坚持定时器**，为了解决死锁情况；

#### 拥塞控制

* 一条数据链路会经过非常多的设备；
* 数据链路中各个部分都有可能成为网络传输的瓶颈；

* **拥塞控制：**考虑整个网络，是全局性的考虑；**流量控制：**考虑的是点对点的通信量的控制；
* 报文超时则认为是拥塞；
* 算法：
  * 慢启动算法；
  * 拥塞避免算法；

> 不进行具体展开

#### TCP连接的建立

三次握手：

![三次握手](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751772.PNG)

* 第一次握手：SYN=1，seq=x
* 第二次握手：SYN=1，ACK=1，seq=y，ack=x+1
* 第三次握手：ACK=1，seq=x+1，ack=y+1

**问：为什么需要3次握手？**

答：已经失效的连接请求报文传送到对方，引起错误；

1. 即假设Client需要和Server建立连接，但是出现了在连接过程中数据报延迟达到的情况；
2. 而Client未收到回应，则以为数据丢失了，再次发送连接请求数据包；
3. 若两次握手就可建立连接，则上述情况服务器收到了多个请求，则会建立起多个连接，而Client实际上只是一次请求，只需要建立一个连接即可；

![为什么三次握手](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751461.PNG)

#### TCP连接的断开

四次挥手：

![四次挥手](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751513.PNG)

* 第一次挥手：FIN=1，seq=u
* 第二次挥手：ACK=1，seq=v，ack=u+1
* 第三次挥手：FIN=1，ACK=1，seq=w，ack=u+1
* 第四次挥手：ACK=1，seq=u+1，ack=w+1

TCP中的第三个定时器：**等待计时器**

* 等待计时器会等待2MSL时间；

  > Max Segment Lifetime，最长报文段寿命，通常为2分钟

* 2ML设置，是为了确保发送方发送的最后一个报文（第四次挥手报文）能成功抵达接受方；

* 若接收方没有收到发送方的最后一个报文（第四次挥手报文），则会重新向发送方发送请求断开报文（第三次挥手报文）；

* 发送方在2ML时间内，没有收到请求断开报文（第三次挥手报文），则可以将连接关闭；

* 确保当前连接的所有报文都已经过期了。

**问：为什么需要4次挥手？**

答：确保数据能够完成传输；即当收到FIN报文时（第一次挥手），仅表示对方已经没有数据发给你了，但是自己的数据却并不意味着已经完全发送给对方了；因此在收到对方的FIN报文后，对其进行响应ACK后（第二次挥手），继续发送数据，直到自己的数据也发送完成后再发送FIN报文（第三次挥手），告诉对方自己的数据也发送完成，表示已经可以进行连接的关闭了，对方接受到了FIN报文后返回ACK确认报文（第四次挥手），双方关闭连接。

## 应用层

### DNS

DNS，Domain Name System，域名系统，即通过该技术，能将域名转换为IP地址；

正向解析：将域名转换为IP地址；

反向解析：将IP地址解析为域名；

![域名分层](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751195.PNG)

DNS协议运行在UDP协议之上，使用53号端口；

**DNS解析顺讯**

1. 浏览器缓存；

2. 本机的hosts文件；

3. 路由缓存；

4. DNS查询：

![DNS查询](https://xycnotes.oss-cn-hangzhou.aliyuncs.com/img/202206251751725.PNG)

### HTTP/HTTPS

[计算机网络基础：HTTP](https://xianyuchao.cn/2020/05/10/%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%EF%BC%9AHTTP/)

### 其他

FTP，SSH，HTML，待续... ...

## 参考

《图解TCP/IP》 [日本]竹下隆史等

